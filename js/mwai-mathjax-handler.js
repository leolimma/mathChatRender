function d(t){if(t.addedNodes?.length){for(let e of t.addedNodes)if(e){if(e.nodeType===1){if(e.matches?.(".mwai-reply")||e.querySelector?.(".mwai-reply"))return!0;let r=e.textContent||"";if(/\$|\\\(|\\\[/.test(r))return!0}if(e.nodeType===3&&/\$|\\\(|\\\[/.test(e.data||""))return!0}}if(t.type==="characterData"){let e=t.target?.data||"";if(/\$|\\\(|\\\[/.test(e))return!0}return!1}function h(t){for(let e of t)if(e.nodeType===1){if(e.matches?.(".mwai-conversation"))return e;let r=e.querySelector?.(".mwai-conversation");if(r)return r}return null}function c(t){try{t&&typeof t.disconnect=="function"&&t.disconnect()}catch(e){console.warn("MathChatRender: erro ao desconectar observer",e)}}globalThis.mcr=globalThis.mcr||{};globalThis.mcrConfig=globalThis.mcrConfig||{};globalThis.mcr.setConfig=function(t){typeof t=="object"&&(globalThis.mcrConfig=Object.assign(globalThis.mcrConfig||{},t))};globalThis.mcr.typeset=function(t){return new Promise((e,r)=>{globalThis.MathJax&&MathJax.typesetPromise?MathJax.typesetPromise([t]).then(e).catch(r):r(new Error("MathJax not ready"))})};globalThis.mcr.refresh=function(){let t=document.querySelector(".mwai-chatbot-container");if(!t)return Promise.resolve();let e=t.querySelector(".mwai-conversation");return e?globalThis.mcr.typeset(e):Promise.resolve()};function f(t=5e3,e=100){return new Promise((r,o)=>{let n=Math.ceil(t/e),a=0,i=setInterval(()=>{a++,globalThis.MathJax&&MathJax.startup&&MathJax.startup.promise?(clearInterval(i),r()):a>=n&&(clearInterval(i),o(new Error("MathJax startup n\xE3o encontrado dentro do timeout")))},e)})}function m(){let t=null;return function(e,r){clearTimeout(t),t=setTimeout(e,r)}}var g=m();function u(t){t&&requestAnimationFrame(()=>{try{t.scrollTop=t.scrollHeight}catch(e){console.warn("MathChatRender: erro ao for\xE7ar scroll",e)}})}async function b(t,e){let r=t.querySelector(".mwai-reply:last-child");if(r){c(e.current);try{await globalThis.MathJax.typesetPromise([r]),u(t)}catch(o){console.error("MathChatRender: Erro ao renderizar MathJax:",o)}finally{e.current&&e.current.observe(t,{childList:!0,subtree:!0,characterData:!0})}}}function l(t){console.log("MathChatRender: .mwai-conversation encontrado! Anexando observador de mensagens.");let e=t.closest(".mwai-body")||document.querySelector(".mwai-chat .mwai-body"),r={childList:!0,subtree:!0,characterData:!0},o={current:null};o.current=new MutationObserver(n=>{n.some(d)&&g(()=>b(e,o),250)}),c(o.current),(async()=>{try{await globalThis.MathJax.typesetPromise([t]),u(e)}catch(n){console.log("MathChatRender: Erro ao renderizar hist\xF3rico:",n)}finally{o.current&&o.current.observe(t,r)}})(),globalThis.addEventListener("pagehide",()=>c(o.current))}await f();if(!globalThis.MathJax?.startup?.promise)console.error("MathChatRender: MathJax startup n\xE3o encontrado no tempo limite.");else{let t=function(){let e=document.querySelector(".mwai-chatbot-container");if(!e){console.error("MathChatRender: Container RAIZ (.mwai-chatbot-container) n\xE3o encontrado.");return}let r=e.querySelector(".mwai-conversation");if(r){l(r);return}console.log("MathChatRender: .mwai-conversation n\xE3o encontrado. Aguardando ser adicionado ao DOM...");let o=new MutationObserver((n,a)=>{for(let i of n)if(i.addedNodes?.length){let s=h(i.addedNodes);if(s){l(s),c(a);return}}});o.observe(e,{childList:!0,subtree:!0}),globalThis.addEventListener("pagehide",()=>c(o))};await globalThis.MathJax.startup.promise,console.log("MathChatRender: MathJax v4 iniciado. A executar o observador do chat."),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}

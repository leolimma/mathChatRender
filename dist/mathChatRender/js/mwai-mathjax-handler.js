function h(e){for(let t of e)if(t.nodeType===1){if(t.matches?.(".mwai-conversation"))return t;let r=t.querySelector?.(".mwai-conversation");if(r)return r}return null}function n(e){try{e&&typeof e.disconnect=="function"&&e.disconnect()}catch(t){console.warn("MathChatRender: erro ao desconectar observer",t)}}globalThis.mcr=globalThis.mcr||{};globalThis.mcrConfig=globalThis.mcrConfig||{};globalThis.mcr.setConfig=function(e){typeof e=="object"&&(globalThis.mcrConfig=Object.assign(globalThis.mcrConfig||{},e))};globalThis.mcr.typeset=function(e){return new Promise((t,r)=>{globalThis.MathJax&&MathJax.typesetPromise?MathJax.typesetPromise([e]).then(t).catch(r):r(new Error("MathJax not ready"))})};globalThis.mcr.refresh=function(){let e=document.querySelector(".mwai-chatbot-container");if(!e)return Promise.resolve();let t=e.querySelector(".mwai-conversation");return t?globalThis.mcr.typeset(t):Promise.resolve()};function f(e=5e3,t=100){return new Promise((r,o)=>{let a=Math.ceil(e/t),i=0,c=setInterval(()=>{i++,globalThis.MathJax&&MathJax.startup&&MathJax.startup.promise?(clearInterval(c),r()):i>=a&&(clearInterval(c),o(new Error("MathJax startup n\xE3o encontrado dentro do timeout")))},t)})}function m(){let e=null;return function(t,r){clearTimeout(e),e=setTimeout(t,r)}}var y=m();function d(e){e&&requestAnimationFrame(()=>{try{e.scrollTop=e.scrollHeight}catch(t){console.warn("MathChatRender: erro ao for\xE7ar scroll",t)}})}async function b(e,t){if(!e)return;let r=e.closest(".mwai-body")||document.querySelector(".mwai-chat .mwai-body");n(t.current);try{let o=e.querySelector(".mwai-reply:last-child");if(!o)return;await globalThis.MathJax.typesetPromise([o]),d(r)}catch(o){console.error("MathChatRender: Erro ao renderizar MathJax:",o)}finally{t.current&&t.current.observe(e,{childList:!0,subtree:!0,characterData:!0})}}function u(e){console.log("MathChatRender: .mwai-conversation encontrado! Anexando observador de mensagens.");let t=e.closest(".mwai-body")||document.querySelector(".mwai-chat .mwai-body"),r={childList:!0,subtree:!0,characterData:!0},o={current:null};o.current=new MutationObserver(a=>{y(()=>b(e,o),250)}),n(o.current),(async()=>{try{await globalThis.MathJax.typesetPromise([e]),d(t)}catch(a){console.log("MathChatRender: Erro ao renderizar hist\xF3rico:",a)}finally{o.current&&o.current.observe(e,r)}})(),globalThis.addEventListener("pagehide",()=>n(o.current))}(async function(){try{if(await f(),!globalThis.MathJax?.startup?.promise){console.error("MathChatRender: MathJax startup n\xE3o encontrado no tempo limite.");return}await globalThis.MathJax.startup.promise,console.log("MathChatRender: MathJax v4 iniciado. A executar o observador do chat.");let t=()=>{let r=document.querySelector(".mwai-chatbot-container");if(!r){console.error("MathChatRender: Container RAIZ (.mwai-chatbot-container) n\xE3o encontrado.");return}let o=r.querySelector(".mwai-conversation");if(o){u(o);return}console.log("MathChatRender: .mwai-conversation n\xE3o encontrado. Aguardando ser adicionado ao DOM...");let a=new MutationObserver((i,c)=>{for(let s of i)if(s.addedNodes?.length){let l=h(s.addedNodes);if(l){u(l),n(c);return}}});a.observe(r,{childList:!0,subtree:!0}),globalThis.addEventListener("pagehide",()=>n(a))};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()}catch(t){console.error("MathChatRender: Falha ao inicializar o handler do MathJax",t)}})();
